# FDS 神经网络蒸馏技术方案（Draft v0.1）

## 1. 背景与目标
- 目标：构建一个神经网络模型，学习 FDS（Fire Dynamics Simulator）仿真行为，在可接受误差下大幅降低推理耗时。
- 硬性目标（本项目验收门槛）：
  - 推理延迟达到秒级：`P95 单次推理延迟 <= 1.0s`（单工况、标准硬件环境）。
  - 准确率不低于 85%：`Accuracy >= 85%`（按第 5 节口径在测试集计算）。
- 预期收益：
  - 将分钟级/小时级仿真，压缩到秒级/毫秒级预测（视场景复杂度而定）。
  - 支持快速参数扫描、在线决策或实时可视化。
  - 为后续控制、优化、反演任务提供可微近似模型。

### 1.1 当前业务目标（优先级）
- 业务 A：气体浓度预测
  - 核心指标：`CO`、`CO2`、`O2` 的关键点时序与峰值/末值。
  - 首版标签来源：`*_devc.csv` 中 `CO_VOL`、`CO2_VOL`、`O2_VOL`。
  - 首版输出字段：
    - `gas_co_max_ppm`
    - `gas_co2_max_vol_frac`
    - `gas_o2_min_vol_frac`
- 业务 B：火情预测
  - 核心指标：关键点温度时序与峰值。
  - 首版标签来源：`*_devc.csv` 中 `TEMP_FIRE`、`TEMP_CENTER`。
  - 首版输出字段：
    - `fire_temp_fire_peak_c`
    - `fire_temp_center_peak_c`

说明：当前仓库首版真实标签已从 `run.log` 扩展到 `*_devc.csv`，后续以业务 A/B 标签为主，不再以运行时长标签作为核心业务目标。

## 2. 思路是否合理
结论：合理，但建议采用“分阶段蒸馏/替代建模”路线，而不是一次到位。

- 合理性：
  - FDS 本质是偏微分方程数值求解，存在较强规律性，可由神经网络近似。
  - 在固定或受限场景分布内（几何、边界条件、火源范围受控），替代模型效果通常显著。
- 关键前提：
  - 明确定义输入分布，避免“全场景泛化”目标过大。
  - 数据覆盖要足够，尤其是边界工况和极端工况。
  - 评估指标必须同时包含数值误差与物理一致性约束。

## 3. 推荐技术路线（已确定）
已确定采用：`数据驱动 surrogate（主干） -> 蒸馏增强（提精度/提速度） -> 软物理约束（提稳定性）`。

不采用“纯 PINN”作为主路线，原因：
- 在 FDS 这类强耦合非线性问题中，纯 PINN 训练稳定性和收敛速度通常不占优。
- 当前项目有能力批量生成 FDS 监督数据，数据驱动路线更容易在周期内达到 `Accuracy >= 85%`。
- 秒级推理目标更依赖模型结构轻量化与部署优化，而非 PINN 形式本身。

### 3.1 路线分层
- L1（MVP 层）：低维代理模型
  - 输入：工况参数（火源、边界、几何摘要）。
  - 输出：关键传感器时序（温度/烟气/浓度）。
  - 目标：最快达到 `Accuracy >= 85%` 与 `P95 <= 1.0s`。
- L2（增强层）：蒸馏与多保真
  - Teacher：高精度 FDS 输出（必要时加入高分辨率子集）。
  - Student：轻量网络（部署友好）。
  - 目标：在不增加推理延迟的前提下提升精度与 OOD 稳定性。
- L3（稳健层）：软物理约束与置信度门控
  - 在损失中加入物理约束项（非负、边界、守恒残差）。
  - 为低置信度样本启用回退策略（回退 FDS 或高精度代理）。

### 3.2 模型选型优先级
- 低维时序任务（首选顺序）：
  - `MLP + 时间位置编码`（首版最稳，训练快，部署最简）。
  - `Temporal Transformer / TCN`（当长时依赖明显时启用）。
- 场预测任务（首选顺序）：
  - `FNO`（对 PDE 类算子学习更匹配，推理快）。
  - `U-Net`（工程成熟度高，便于做多尺度监督）。
  - 时空 Transformer（仅在前两者无法达标时考虑，因成本更高）。

### 3.3 技术淘汰与切换条件
- 任何候选模型若连续两个版本满足以下任一条件则降级或淘汰：
  - 测试集 `Accuracy < 85%`。
  - `P95 > 1.0s`（标准硬件）。
  - OOD 集关键指标显著劣化（相对上版下降 > 5%）。
- 触发切换后执行：
  - 优先保留当前最优轻量 Student 作为主线。
  - 追加困难样本再训练，并开启蒸馏或物理约束增强。

### 阶段 A：数据引擎与任务定义
- 定义输入：
  - 几何与网格摘要（可先简化为参数化房间/通道）。
  - 火源参数（位置、热释放速率 HRR 曲线、持续时间）。
  - 边界条件（通风、开口、初始温度、材料参数）。
- 定义输出（优先低维再到高维）：
  - 低维：关键点温度/烟层高度/CO 浓度等时序。
  - 高维：2D/3D 场（温度场、速度场、浓度场）。
- 建立自动化数据生成：
  - 参数采样（LHS/随机 + 边界加密采样）。
  - 批量运行 FDS，抽取统一格式数据（建议 HDF5/Parquet + 元数据 JSON）。
  - 划分 train/val/test，另建 OOD 测试集（超出训练分布）。

### 阶段 B：基线 surrogate 模型
- 推荐从“可训稳、可解释、可部署”的基线开始：
  - 低维任务：`MLP` 起步，必要时升级 `Temporal Transformer/TCN`。
  - 场预测任务：`FNO` 优先，`U-Net` 作为强基线补充。
- 训练目标：
  - 监督损失：MSE/MAE + 多尺度损失（场任务）。
  - 加权策略：对关键区域（火源附近、疏散通道）提高权重。
- 基线通过标准：
  - 指标达到业务阈值（见第 5 节）。
  - 推理速度相对 FDS 提升至少一个数量级。

### 阶段 C：蒸馏增强与物理约束
- 蒸馏策略（Teacher = 高精度 FDS 输出，Student = 轻量网络）：
  - 输出蒸馏：直接拟合 Teacher 结果。
  - 特征蒸馏：对中间表征做对齐（适用于大模型 teacher）。
  - 多保真蒸馏：低精度快速仿真 + 少量高精度样本联合训练。
- 物理一致性增强（软约束，非纯 PINN）：
  - 在损失中加入守恒/单调性/边界条件惩罚项。
  - 使用 PINN-style 软约束或后处理投影修正。
- 压缩部署：
  - 剪枝、量化（INT8/FP16）、ONNX/TensorRT 导出。

## 4. 数据与工程方案
- 数据规模（建议起步）：
  - 低维任务：1e4 ~ 1e5 组工况。
  - 高维任务：1e3 ~ 1e4 组工况（视网格与时间分辨率）。
- 数据版本管理：
  - 建议使用 DVC 或明确的 `dataset_version` + 配置快照。
- 训练工程：
  - 配置化（YAML）管理实验参数。
  - 实验追踪（MLflow/W&B）。
  - 固定随机种子 + 记录 commit hash，保障可复现。

## 5. 评估指标（必须同时满足）
- 准确率口径（统一定义）：
  - 对每个关键输出计算 `NMAE = MAE / (max(y_true)-min(y_true)+eps)`。
  - 采用 `Accuracy = max(0, 1 - NMAE) * 100%`，再对所有输出与时间步做平均。
  - 避免不同任务口径冲突，首版统一使用该定义；后续可增加任务专用指标。
- 数值误差：
  - 点位时序：MAE、RMSE、峰值误差、峰值时刻偏差。
  - 场误差：相对 L2、SSIM（若做切片图像化评估）。
- 物理合理性：
  - 非负性、边界条件满足率、守恒残差统计。
- 泛化能力：
  - IID 测试集与 OOD 测试集分别报告。
- 效率：
  - 单次推理延迟、吞吐、显存占用。
  - 相对 FDS 加速比（xN）。

建议验收阈值（首版，可迭代）：
- 关键点温度 MAE < 10%（或绝对温差阈值由业务定义）。
- 峰值温度误差 < 15%，峰值时刻误差 < 10% 时间窗。
- 准确率 `Accuracy >= 85%`（测试集）。
- 时延 `P95 <= 1.0s`（单工况推理）。
- 推理速度相对 FDS 加速 >= 20x（建议目标，若与 P95 冲突以 P95 为硬门槛）。

### 5.1 两类业务的首版验收口径
- 气体浓度预测（业务 A）：
  - 回归指标：`MAE/NMAE/Accuracy`（对 `gas_co_max_ppm`、`gas_co2_max_vol_frac`、`gas_o2_min_vol_frac` 逐项统计并平均）。
  - 报警指标（可选）：`gas_co_alarm_50ppm` 的准确率/F1。
- 火情预测（业务 B）：
  - 回归指标：`MAE/NMAE/Accuracy`（对 `fire_temp_fire_peak_c`、`fire_temp_center_peak_c` 逐项统计并平均）。
  - 报警指标（可选）：`fire_high_temp_alarm` 的准确率/F1。
- 统一门槛：
  - `Accuracy >= 85%`（测试集，按上述字段聚合）。
  - `P95 <= 1.0s`（单工况推理，标准硬件）。

## 6. 里程碑
- M1（1~2 周）：完成参数空间定义、自动化数据生成脚本、首批数据集。
- M2（2~4 周）：完成基线模型训练与评估，拿到第一版可用 surrogate。
- M3（2~4 周）：加入蒸馏 + 物理约束，优化 OOD 稳定性。
- M4（1~2 周）：模型压缩部署与接口封装（CLI/API）。

## 7. 风险与应对
- 风险：数据覆盖不足导致“看起来准，边界工况崩”。
  - 应对：主动学习/误差驱动补样；单独维护困难样本集。
- 风险：高维场预测训练成本高。
  - 应对：先做低维 KPI 任务，逐步扩展到场预测。
- 风险：模型违反物理规律。
  - 应对：物理约束损失 + 后处理修正 + 规则告警。

## 8. 建议的最小可行版本（MVP）
- 仅针对“参数化单房间 + 固定网格 + 指定火源范围”。
- 输出 10~30 个关键传感器点位的温度/烟气时序。
- 在该受限分布内达到 `Accuracy >= 85%` 且 `P95 <= 1.0s`，再扩场景。

## 9. 下一步
- 先确认：
  - 目标场景边界（几何复杂度、是否多房间）。
  - 首版输出指标（点位时序 or 全场）。
  - 可接受误差与最低加速比。
- 确认后进入数据引擎脚本与目录结构落地（`configs/`, `data/`, `train/`, `eval/`）。

## 10. 开发流程约束（强制）
- 全流程严格遵循 Git Flow（详见 `docs/gitflow.md`）。
- 所有开发必须先创建 Issue（详见 `docs/issue-flow.md`）。
- 禁止直接向 `main` 与 `develop` 提交代码。
- 所有开发工作必须从 `feature/*` 分支发起，并通过 PR 合并。
- 所有设计、实现、测试文档统一使用详细中文维护。
